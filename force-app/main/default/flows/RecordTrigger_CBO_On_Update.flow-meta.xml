<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <actionCalls>
        <description>Send email to client when lifetime storage</description>
        <name>EmailAlert_Lifetime_Upgrade_Confirm</name>
        <label>EmailAlert - Lifetime Upgrade Confirm</label>
        <locationX>479</locationX>
        <locationY>431</locationY>
        <actionName>fw1__Invoice__c.Lifetime_Storage_Upgrade_Order_Confirmation</actionName>
        <actionType>emailAlert</actionType>
        <connector>
            <targetReference>Send_email_of_Lifetime_Storage_Upgrade_to_Client_Services</targetReference>
        </connector>
        <flowTransactionModel>CurrentTransaction</flowTransactionModel>
        <inputParameters>
            <name>SObjectRowId</name>
            <value>
                <elementReference>$Record.Id</elementReference>
            </value>
        </inputParameters>
        <nameSegment>fw1__Invoice__c.Lifetime_Storage_Upgrade_Order_Confirmation</nameSegment>
    </actionCalls>
    <actionCalls>
        <description>This step will send an email of the order confirmation to client services.</description>
        <name>Send_email_of_Lifetime_Storage_Upgrade_to_Client_Services</name>
        <label>Send email of Lifetime Storage Upgrade to Client Services</label>
        <locationX>479</locationX>
        <locationY>539</locationY>
        <actionName>fw1__Invoice__c.Lifetime_Storage_Upgrade_Order_Confirmation_Client_Services</actionName>
        <actionType>emailAlert</actionType>
        <connector>
            <targetReference>Is_Genome_Cheek_Order</targetReference>
        </connector>
        <flowTransactionModel>CurrentTransaction</flowTransactionModel>
        <inputParameters>
            <name>SObjectRowId</name>
            <value>
                <elementReference>$Record.Id</elementReference>
            </value>
        </inputParameters>
        <nameSegment>fw1__Invoice__c.Lifetime_Storage_Upgrade_Order_Confirmation_Client_Services</nameSegment>
    </actionCalls>
    <actionCalls>
        <description>Send Email alert to CS Team for Cheek Order.</description>
        <name>Send_Genome_Cheek_Ordered_to_CS</name>
        <label>Send Genome Cheek Ordered to CS</label>
        <locationX>479</locationX>
        <locationY>839</locationY>
        <actionName>fw1__Invoice__c.Genome_Cheek_Ordered</actionName>
        <actionType>emailAlert</actionType>
        <connector>
            <targetReference>Update_Baby_Records_Set_Genome_Fields_for_Cheek</targetReference>
        </connector>
        <flowTransactionModel>CurrentTransaction</flowTransactionModel>
        <inputParameters>
            <name>SObjectRowId</name>
            <value>
                <elementReference>$Record.Id</elementReference>
            </value>
        </inputParameters>
        <nameSegment>fw1__Invoice__c.Genome_Cheek_Ordered</nameSegment>
    </actionCalls>
    <actionCalls>
        <description>This action will send a tissue donation email.</description>
        <name>Send_Tissue_Donation_Email</name>
        <label>Send Tissue Donation Email</label>
        <locationX>50</locationX>
        <locationY>1787</locationY>
        <actionName>emailSimple</actionName>
        <actionType>emailSimple</actionType>
        <flowTransactionModel>CurrentTransaction</flowTransactionModel>
        <inputParameters>
            <name>emailAddresses</name>
            <value>
                <elementReference>constTissueDonationEmailRecipients</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>senderType</name>
            <value>
                <stringValue>OrgWideEmailAddress</stringValue>
            </value>
        </inputParameters>
        <inputParameters>
            <name>senderAddress</name>
            <value>
                <elementReference>constTTissueDonationSenderEmailAddress</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>emailSubject</name>
            <value>
                <stringValue>A New Blood/Tissue Donation Order Created</stringValue>
            </value>
        </inputParameters>
        <inputParameters>
            <name>emailBody</name>
            <value>
                <elementReference>textTempTissueDonationEmailBody</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>sendRichBody</name>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </inputParameters>
        <inputParameters>
            <name>relatedRecordId</name>
            <value>
                <elementReference>$Record.Id</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>logEmailOnSend</name>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </inputParameters>
        <nameSegment>emailSimple</nameSegment>
    </actionCalls>
    <apiVersion>56.0</apiVersion>
    <areMetricsLoggedToDataCloud>false</areMetricsLoggedToDataCloud>
    <constants>
        <description>Constant for setting cheek swab.</description>
        <name>constTCheekSwab</name>
        <dataType>String</dataType>
        <value>
            <stringValue>CHEEK SWAB ORDER - CS TO HANDLE</stringValue>
        </value>
    </constants>
    <constants>
        <description>List of email addresses that get the Tissue Donation Email</description>
        <name>constTissueDonationEmailRecipients</name>
        <dataType>String</dataType>
        <value>
            <stringValue>lab-team@americordblood.com,clients@americordblood.com</stringValue>
        </value>
    </constants>
    <constants>
        <description>This is the sender email address for the placenta tissue donation.</description>
        <name>constTTissueDonationSenderEmailAddress</name>
        <dataType>String</dataType>
        <value>
            <stringValue>clients@americordblood.com</stringValue>
        </value>
    </constants>
    <decisions>
        <description>Determine if products/services/storage change</description>
        <name>Did_Products_Services_Storage_Change</name>
        <label>Did Products/Services/Storage Change</label>
        <locationX>380</locationX>
        <locationY>1355</locationY>
        <defaultConnectorLabel>No Change</defaultConnectorLabel>
        <rules>
            <name>Yes_Products_Services_Storage_Changed</name>
            <conditionLogic>or</conditionLogic>
            <conditions>
                <leftValueReference>$Record.Products_or_Services_Ordered_Formatted__c</leftValueReference>
                <operator>NotEqualTo</operator>
                <rightValue>
                    <elementReference>Call_Calculate_Products_Services_Ordered.varTProductsServicesOrdered</elementReference>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.Storage_Ordered_Formatted__c</leftValueReference>
                <operator>NotEqualTo</operator>
                <rightValue>
                    <elementReference>Call_Calculate_Products_Services_Ordered.varTStorageOrdered</elementReference>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Update_CBO_with_Calculate_Flow_Output</targetReference>
            </connector>
            <label>Yes - Products/Services/Storage Changed</label>
        </rules>
    </decisions>
    <decisions>
        <description>Determine if this order contains genome cheek service.</description>
        <name>Is_Genome_Cheek_Order</name>
        <label>Is Genome Cheek Order</label>
        <locationX>611</locationX>
        <locationY>731</locationY>
        <defaultConnector>
            <targetReference>Is_Upgrade</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>NO - Not Genome Cheek</defaultConnectorLabel>
        <rules>
            <name>YES_Genome_Cheek</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record.Is_Genome_Cheek_Order__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Send_Genome_Cheek_Ordered_to_CS</targetReference>
            </connector>
            <doesRequireRecordChangedToMeetCriteria>true</doesRequireRecordChangedToMeetCriteria>
            <label>YES - Genome Cheek</label>
        </rules>
    </decisions>
    <decisions>
        <description>Determine if the blood/tissue donation field went from unchecked to checked.</description>
        <name>Is_There_A_Change_To_Blood_Tissue_Donation</name>
        <label>Is There A Change To Blood/Tissue Donation</label>
        <locationX>182</locationX>
        <locationY>1679</locationY>
        <defaultConnectorLabel>NO - Blood/Tissue Not Checked</defaultConnectorLabel>
        <rules>
            <name>YES_Now_Blood_Tissue_Donate_Is_Checked</name>
            <conditionLogic>or</conditionLogic>
            <conditions>
                <leftValueReference>$Record.Tissue_Donation__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.Blood_Donation__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Send_Tissue_Donation_Email</targetReference>
            </connector>
            <doesRequireRecordChangedToMeetCriteria>true</doesRequireRecordChangedToMeetCriteria>
            <label>YES - Now Blood/Tissue Donate Is Checked</label>
        </rules>
    </decisions>
    <decisions>
        <description>Check to see if we are an Upgrade type and then dont update products ordered.</description>
        <name>Is_Upgrade</name>
        <label>Is Upgrade?</label>
        <locationX>611</locationX>
        <locationY>1139</locationY>
        <defaultConnectorLabel>YES - Upgrade</defaultConnectorLabel>
        <rules>
            <name>NO_Not_Upgrade</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record.RecordType.Name</leftValueReference>
                <operator>NotEqualTo</operator>
                <rightValue>
                    <stringValue>Upgrade</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Call_Calculate_Products_Services_Ordered</targetReference>
            </connector>
            <label>NO - Not Upgrade</label>
        </rules>
    </decisions>
    <decisions>
        <description>Determine if this is an upgrade invoice and if Autobill Pay has been checked.</description>
        <name>Is_Upgrade_and_AutoBill_Checked</name>
        <label>Is Upgrade and AutoBillPay Checked</label>
        <locationX>611</locationX>
        <locationY>323</locationY>
        <defaultConnector>
            <targetReference>Is_Genome_Cheek_Order</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Not Upgrade OR Not Autobill Checked</defaultConnectorLabel>
        <rules>
            <name>Upgrade_and_Autobill_Checked</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record.RecordType.DeveloperName</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Upgrade</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.fw1__Auto_BillPay__c</leftValueReference>
                <operator>IsChanged</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.fw1__Auto_BillPay__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>EmailAlert_Lifetime_Upgrade_Confirm</targetReference>
            </connector>
            <label>Upgrade and Autobill Checked</label>
        </rules>
    </decisions>
    <description>Use this flow to perform functions when the CBO has been updated.</description>
    <environments>Default</environments>
    <formulas>
        <description>This formula will create a text that can be used for the url link to the lab record.</description>
        <name>formTURLLinkToLabRecord</name>
        <dataType>String</dataType>
        <expression>LEFT({!$Api.Partner_Server_URL_550}, FIND( &apos;/services&apos;, {!$Api.Partner_Server_URL_550}))&amp;{!$Record.Lab__r.Id}</expression>
    </formulas>
    <interviewLabel>RecordTrigger: CBO On Update {!$Flow.CurrentDateTime}</interviewLabel>
    <label>RecordTrigger: Cord Blood Order After Update</label>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>AUTO_LAYOUT_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <recordUpdates>
        <description>Update the baby records for Genome cheek order - indicate Cheek swab.</description>
        <name>Update_Baby_Records_Set_Genome_Fields_for_Cheek</name>
        <label>Update Baby Records - Set Genome Fields for Cheek</label>
        <locationX>479</locationX>
        <locationY>947</locationY>
        <connector>
            <targetReference>Is_Upgrade</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Lab__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.Lab__c</elementReference>
            </value>
        </filters>
        <inputAssignments>
            <field>My_Newborn_Order_Status__c</field>
            <value>
                <elementReference>constTCheekSwab</elementReference>
            </value>
        </inputAssignments>
        <object>Baby__c</object>
    </recordUpdates>
    <recordUpdates>
        <description>Update the calling record with the new calculated flow output.</description>
        <name>Update_CBO_with_Calculate_Flow_Output</name>
        <label>Update CBO with Calculate Flow Output</label>
        <locationX>182</locationX>
        <locationY>1463</locationY>
        <connector>
            <targetReference>Update_Lab_with_Ordered_Values</targetReference>
        </connector>
        <inputAssignments>
            <field>Blood_Donation__c</field>
            <value>
                <elementReference>Call_Calculate_Products_Services_Ordered.varBoolBloodDonation</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Cord_Blood_2_0_Ordered__c</field>
            <value>
                <elementReference>Call_Calculate_Products_Services_Ordered.varNCBOrderedTotal</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Cord_Tissue_Ordered__c</field>
            <value>
                <elementReference>Call_Calculate_Products_Services_Ordered.varNCTOrderedTotal</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Exosomes_Ordered__c</field>
            <value>
                <elementReference>Call_Calculate_Products_Services_Ordered.varNEXOrderedTotal</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Maternal_Exosomes_Ordered__c</field>
            <value>
                <elementReference>Call_Calculate_Products_Services_Ordered.varNMXOrderedTotal</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Placenta_2_0_Ordered__c</field>
            <value>
                <elementReference>Call_Calculate_Products_Services_Ordered.varNPTOrderedTotal</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Products_or_Services_Ordered_Formatted__c</field>
            <value>
                <elementReference>Call_Calculate_Products_Services_Ordered.varTProductsServicesOrdered</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Storage_Ordered_Formatted__c</field>
            <value>
                <elementReference>Call_Calculate_Products_Services_Ordered.varTStorageOrdered</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Tissue_Donation__c</field>
            <value>
                <elementReference>Call_Calculate_Products_Services_Ordered.varBoolTissueDonation</elementReference>
            </value>
        </inputAssignments>
        <inputReference>$Record</inputReference>
    </recordUpdates>
    <recordUpdates>
        <description>Update the associated lab with ordered values.</description>
        <name>Update_Lab_with_Ordered_Values</name>
        <label>Update Lab with Ordered Values</label>
        <locationX>182</locationX>
        <locationY>1571</locationY>
        <connector>
            <targetReference>Is_There_A_Change_To_Blood_Tissue_Donation</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.Lab__r.Id</elementReference>
            </value>
        </filters>
        <inputAssignments>
            <field>Blood_Donation__c</field>
            <value>
                <elementReference>Call_Calculate_Products_Services_Ordered.varBoolBloodDonation</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Cord_Blood_Donation__c</field>
            <value>
                <elementReference>Call_Calculate_Products_Services_Ordered.varTCordBloodDonation</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Cord_Blood_Storage__c</field>
            <value>
                <elementReference>Call_Calculate_Products_Services_Ordered.varTCordBloodStorage</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Cord_Tissue_Donation__c</field>
            <value>
                <elementReference>Call_Calculate_Products_Services_Ordered.varTCordTissueDonation</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Cord_Tissue_Storage__c</field>
            <value>
                <elementReference>Call_Calculate_Products_Services_Ordered.varTCordTissueStorage</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Exosome_Storage__c</field>
            <value>
                <elementReference>Call_Calculate_Products_Services_Ordered.varTExosomeStorage</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Maternal_Exosome_Storage__c</field>
            <value>
                <elementReference>Call_Calculate_Products_Services_Ordered.varTMaternalExosomeStorage</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Placenta_Tissue_Donation__c</field>
            <value>
                <elementReference>Call_Calculate_Products_Services_Ordered.varTPlacentaTissueDonation</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Placenta_Tissue_Storage__c</field>
            <value>
                <elementReference>Call_Calculate_Products_Services_Ordered.varTPlacentaTissueStorage</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Products_or_Services_Ordered_Formatted__c</field>
            <value>
                <elementReference>Call_Calculate_Products_Services_Ordered.varTProductsServicesOrdered</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Storage_Ordered_Formatted__c</field>
            <value>
                <elementReference>Call_Calculate_Products_Services_Ordered.varTStorageOrdered</elementReference>
            </value>
        </inputAssignments>
        <inputAssignments>
            <field>Tissue_Donation__c</field>
            <value>
                <elementReference>Call_Calculate_Products_Services_Ordered.varBoolTissueDonation</elementReference>
            </value>
        </inputAssignments>
        <object>Lab__c</object>
    </recordUpdates>
    <start>
        <locationX>485</locationX>
        <locationY>0</locationY>
        <connector>
            <targetReference>Is_Upgrade_and_AutoBill_Checked</targetReference>
        </connector>
        <object>fw1__Invoice__c</object>
        <recordTriggerType>Update</recordTriggerType>
        <triggerType>RecordAfterSave</triggerType>
    </start>
    <status>Active</status>
    <subflows>
        <description>Call calc products/services ordered</description>
        <name>Call_Calculate_Products_Services_Ordered</name>
        <label>Call Calculate Products/Services Ordered</label>
        <locationX>380</locationX>
        <locationY>1247</locationY>
        <connector>
            <targetReference>Did_Products_Services_Storage_Change</targetReference>
        </connector>
        <flowName>Calculate_Products_Services_Ordered</flowName>
        <inputAssignments>
            <name>varTCordBloodOrderId</name>
            <value>
                <elementReference>$Record.Id</elementReference>
            </value>
        </inputAssignments>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </subflows>
    <textTemplates>
        <description>This is the text template for the Blood/Tissue Donation email body.</description>
        <name>textTempTissueDonationEmailBody</name>
        <isViewedAsPlainText>false</isViewedAsPlainText>
        <text>&lt;p&gt;Lab/CS Teams,&lt;/p&gt;&lt;p&gt;A new blood/tissue donation order has been created.&lt;/p&gt;&lt;p&gt;Here is the &lt;a href=&quot;{!formTURLLinkToLabRecord}&quot; rel=&quot;noopener noreferrer&quot; target=&quot;_blank&quot;&gt;Lab&lt;/a&gt; record.&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;span style=&quot;font-size: 8px;&quot;&gt;This is an automated message sent from Salesforce - &lt;/span&gt;&lt;span style=&quot;font-size: 8px; background-color: rgb(255, 255, 255); color: rgb(68, 68, 68);&quot;&gt;RecordTrigger: Cord Blood Order After Update&lt;/span&gt;&lt;/p&gt;</text>
    </textTemplates>
</Flow>
